<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Virtual Currency Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body{background:#0f111a;color:#fff;font-family:Arial, sans-serif;margin:0}
  h1{color:#00ff88;margin:20px 0 10px;text-align:left;padding-left:5vw}
  .controls{margin:6px 5vw;text-align:left}
  input,button{background:#1a1c2c;color:#00ff88;border:1px solid #00ff88;border-radius:4px;padding:6px 10px;font-size:1em;margin:4px}
  button:hover{background:#00ff88;color:#0f111a;cursor:pointer}
  .chart-container{position:relative;width:90vw;height:70vh;margin:20px auto}
  .time{color:#aaa;font-size:.9em;margin-left:5vw}
  .map-container{position:relative;display:inline-block}
  .branch-line{position:absolute;height:2px;background:#fff;top:50%;left:100%;width:0;transition:width .45s ease}
  .branch-up,.branch-down{position:absolute;width:2px;height:0;background:#fff;transition:height .35s ease .45s}
  .branch-up{top:50%;left:calc(100% + 90px)}
  .branch-down{top:50%;left:calc(100% + 90px)}
  .input-up,.confirm-btn{position:absolute;left:calc(100% + 100px);opacity:0;transition:opacity .25s ease .8s}
  .input-up{top:calc(50% - 40px);width:250px}
  .confirm-btn{top:calc(50% + 18px)}
  .active .branch-line{width:90px}
  .active .branch-up,.active .branch-down{height:30px}
  .active .branch-up{top:calc(50% - 30px)}
  .active .branch-down{top:50%}
  .active .input-up,.active .confirm-btn{opacity:1}
  .hover-box{position:absolute;right:12px;top:12px;background:rgba(17,17,26,0.85);border:1px solid rgba(255,255,255,0.2);border-radius:8px;padding:12px 16px;display:none;flex-direction:column;align-items:flex-start;gap:6px;}
  .hover-line{font-size:14px;line-height:1.4;white-space:nowrap}
  .muted{color:#aaa}
  .field-label{color:#00ff88;font-weight:bold;width:90px;display:inline-block}
  .coin-cell{display:inline-block;width:90px;text-align:right;margin-left:6px}
</style>
</head>
<body>
  <h1>Virtual Currency Price Trend</h1>
  <div class="controls">
    <input id="coinInput" type="text" placeholder="Enter main coin (e.g. ACA)"/>
    <button onclick="loadPrimary()">Update Chart</button>
    <button onclick="setBar('1m')">1m</button>
    <button onclick="setBar('1H')">1h</button>
    <button onclick="setBar('1D')">1d</button>
    <button onclick="setBar('1W')">1w</button>
    <button id="smoothBtn" onclick="toggleSmooth()">Point Smooth</button>
    <button id="clearAxisBtn">Clear Axis</button>

    <div class="map-container" id="mapContainer">
      <button id="addBtn">Add Coin</button>
      <div class="branch-line"></div>
      <div class="branch-up"></div>
      <div class="branch-down"></div>
      <input class="input-up" type="text" id="newCoin" placeholder="Coins (e.g. BTC,RAY,ETH)">
      <button class="confirm-btn" id="confirmBtn">Confirm</button>
    </div>
  </div>
  <div class="time" id="updateTime">Ready.</div>
  <div class="chart-container">
    <canvas id="coinChart"></canvas>
    <div id="hoverBox" class="hover-box">
      <div id="hoverTs" class="hover-line muted"></div>
      <div id="hoverCoins" class="hover-line"></div>
      <div id="hoverRows"></div>
    </div>
  </div>

<script>
const ctx=document.getElementById('coinChart').getContext('2d');
let chart;let currentBar='1D';let smoothMode=false;let lastBatch=[];let axisHidden=false;
const GREEN='#00ff88';
const palette=['#ff4c4c','#4c8cff','#ffb84c','#a64dff','#4dd2ff','#ffd24d','#ff6ad5','#7cffd3','#ff7c43','#43ffd0'];

function fmtVal(v,isQVol=false){if(v===undefined||isNaN(v))return 'â€“';if(isQVol)return Number(v).toFixed(2);if(Math.abs(v)<0.001&&v!==0)return v.toExponential(2);return Number(v).toFixed(5);}
function hexToRGBA(hex, a=0.3){const h=hex.replace('#','');const r=parseInt(h.substring(0,2),16);const g=parseInt(h.substring(2,4),16);const b=parseInt(h.substring(4,6),16);return `rgba(${r},${g},${b},${a})`;}

function initChart(){
  chart=new Chart(ctx,{type:'line',data:{labels:[],datasets:[]},
    options:{responsive:true,maintainAspectRatio:false,
      interaction:{mode:'index',intersect:false},
      elements:{line:{tension:0},point:{radius:3}},
      plugins:{legend:{labels:{color:'#fff',filter:(item,data)=>data.datasets[item.datasetIndex].type==='line'}},tooltip:{enabled:false}},
      scales:{}
    }});
  chart.canvas.addEventListener('mousemove',e=>{
    if(smoothMode)return;
    const active=chart.getElementsAtEventForMode(e,'index',{intersect:false},true);
    if(!active)return;
    const activeSymbols=new Set(active.map(a=>chart.data.datasets[a.datasetIndex]).filter(ds=>ds.type==='line').map(ds=>ds.metaSymbol));
    chart.data.datasets.forEach(ds=>{
      if(ds.type==='bar'){
        const base=ds.metaBaseRGBA,bright=ds.metaBrightRGBA;
        ds.backgroundColor=activeSymbols.has(ds.metaSymbol)?bright:base.replace(/,0\.\d+\)/,',0.15)');
      }
    });
    chart.update('none');
  });
  chart.canvas.addEventListener('mouseleave',()=>{
    chart.data.datasets.forEach(ds=>{if(ds.type==='bar'&&ds.metaBaseRGBA){ds.backgroundColor=ds.metaBaseRGBA;}});
    chart.update('none');
  });
}
initChart();

function ensureAxis(id,color,grid){const s=chart.options.scales;if(!s[id])s[id]={type:'linear',position:'left',grid:{color:'rgba(255,255,255,0.08)',drawOnChartArea:grid},ticks:{color:color,callback:v=>Number(v).toFixed(3)}};else s[id].ticks.color=color;}
function ensureVolAxis(id,color){const s=chart.options.scales;if(!s[id])s[id]={type:'linear',position:'right',grid:{drawOnChartArea:false},ticks:{color:color,callback:v=>v>1e9?(v/1e9).toFixed(1)+'B':v>1e6?(v/1e6).toFixed(1)+'M':v>1e3?(v/1e3).toFixed(1)+'K':v}};else s[id].ticks.color=color;}
function removeAxis(id){if(chart.options.scales[id])delete chart.options.scales[id];}

async function fetchCandles(sym,bar,limit=60){const u=`https://www.okx.com/api/v5/market/candles?instId=${sym}-USDT&bar=${bar}&limit=${limit}`;const r=await fetch(u);const j=await r.json();const raw=(j&&j.data)?j.data.reverse():[];const labels=raw.map(d=>new Date(+d[0]).toLocaleString());const candles=raw.map(d=>({ts:+d[0],o:+d[1],h:+d[2],l:+d[3],c:+d[4],qv:+(d[6]||0)}));return{labels,candles};}

async function addOrUpdate(sym,color,axis,grid=false){
  sym=sym.toUpperCase();ensureAxis(axis,color,grid);
  const volAxis=`yVol_${sym}`;ensureVolAxis(volAxis,color);
  const {labels,candles}=await fetchCandles(sym,currentBar,60);
  if(chart.data.labels.length===0)chart.data.labels=labels;
  let line=chart.data.datasets.find(d=>d.metaSymbol===sym&&d.type==='line');
  if(!line){line={type:'line',label:`${sym}/USDT (${currentBar})`,data:candles.map(x=>x.c),borderColor:color,backgroundColor:'transparent',borderWidth:2,tension:chart.options.elements.line.tension,pointRadius:chart.options.elements.point.radius,order:1,yAxisID:axis,metaSymbol:sym,metaCandles:candles};chart.data.datasets.push(line);}
  else{line.data=candles.map(x=>x.c);line.metaCandles=candles;}
  let bar=chart.data.datasets.find(d=>d.metaSymbol===sym&&d.type==='bar');
  const base=hexToRGBA(color,0.3),bright=hexToRGBA(color,0.8);
  if(!bar){bar={type:'bar',label:`${sym} Volume`,yAxisID:volAxis,backgroundColor:base,borderWidth:0,order:0,data:candles.map(x=>x.qv),metaSymbol:sym,metaBaseRGBA:base,metaBrightRGBA:bright,metaVolAxis:volAxis};chart.data.datasets.unshift(bar);}
  else{bar.data=candles.map(x=>x.qv);bar.metaBaseRGBA=base;bar.metaBrightRGBA=bright;bar.yAxisID=volAxis;bar.backgroundColor=base;}
  chart.update();
  document.getElementById('updateTime').innerText='Last updated: '+new Date().toLocaleTimeString();
}

async function loadPrimary(){chart.data.datasets=chart.data.datasets.filter(d=>d.yAxisID!=='y0');removeAxis('y0');const val=(document.getElementById('coinInput').value||'').trim();if(!val){chart.update();return;}if(chart.data.datasets.length===0)chart.data.labels=[];await addOrUpdate(val.toUpperCase(),GREEN,'y0',true);}
async function setBar(b){currentBar=b;chart.data.labels=[];for(const ds of [...chart.data.datasets.filter(d=>d.type==='line')])await addOrUpdate(ds.metaSymbol,ds.borderColor,ds.yAxisID,ds.yAxisID==='y0');}

function toggleSmooth(){
  smoothMode=!smoothMode;
  chart.options.elements.line.tension=smoothMode?0.5:0;
  chart.options.elements.point.radius=smoothMode?0:3;
  chart.data.datasets.filter(d=>d.type==='line').forEach(d=>{d.tension=chart.options.elements.line.tension;d.pointRadius=chart.options.elements.point.radius;});
  chart.data.datasets.filter(d=>d.type==='bar').forEach(d=>{d.backgroundColor=d.metaBaseRGBA.replace(/0\.\d+\)/,smoothMode? '0.4)': '0.8)');});
  chart.update();
}

const mapContainer=document.getElementById('mapContainer');
const addBtn=document.getElementById('addBtn');
const confirmBtn=document.getElementById('confirmBtn');
const newCoin=document.getElementById('newCoin');
addBtn.addEventListener('click',()=>{if(addBtn.textContent==='Add Coin'){mapContainer.classList.add('active');newCoin.focus();}else{if(lastBatch.length){const axes=new Set();chart.data.datasets=chart.data.datasets.filter(d=>{const hit=lastBatch.includes(d.metaSymbol);if(hit){axes.add(d.yAxisID);if(d.metaVolAxis)axes.add(d.metaVolAxis);}return!hit;});axes.forEach(id=>removeAxis(id));chart.update();lastBatch=[];}addBtn.textContent='Add Coin';mapContainer.classList.remove('active');}});
confirmBtn.addEventListener('click',async()=>{const raw=newCoin.value.trim();if(!raw)return;const all=[...new Set(raw.split(',').map(s=>s.trim().toUpperCase()).filter(Boolean))];if(!all.length)return;lastBatch=[];let axisCount=Object.keys(chart.options.scales).filter(k=>k.startsWith('y')&&k!=='y0').length;let i=0;if(chart.data.datasets.length===0)chart.data.labels=[];for(const sym of all){const exist=chart.data.datasets.find(d=>d.metaSymbol===sym&&d.type==='line');if(exist){await addOrUpdate(sym,exist.borderColor,exist.yAxisID,exist.yAxisID==='y0');continue;}const color=palette[i%palette.length];i++;const axis='y'+(axisCount+i);await addOrUpdate(sym,color,axis,false);lastBatch.push(sym);}addBtn.textContent='Delete Coin';});

function renderHover(active){const box=document.getElementById('hoverBox'),rows=document.getElementById('hoverRows'),ts=document.getElementById('hoverTs'),coins=document.getElementById('hoverCoins');if(!active||!active.length){box.style.display='none';return;}const idx=active[0].index;const fields=['Open','High','Low','Close','QVol (USDT)'];const keys=['o','h','l','c','qv'];const syms=[];let tsText='';const dataMap={};chart.data.datasets.filter(d=>d.type==='line').forEach(ds=>{const c=ds.metaCandles?.[idx];if(!c)return;if(!tsText)tsText=new Date(c.ts).toLocaleString();syms.push({name:ds.metaSymbol,color:ds.borderColor});dataMap[ds.metaSymbol]=c;});ts.textContent='Time: '+tsText;coins.innerHTML='Coins: '+syms.map(s=>`<span style="color:${s.color};margin-right:8px">${s.name}</span>`).join('');rows.innerHTML=fields.map((n,i)=>{let line=`<span class="field-label">${n}:</span>`;syms.forEach(s=>{const c=dataMap[s.name];const v=c?fmtVal(c[keys[i]],keys[i]==='qv'):'â€“';line+=`<span class="coin-cell" style="color:${s.color}">${v}</span>`;});return `<div class="hover-line">${line}</div>`;}).join('');box.style.display='flex';}

async function refreshAll(){for(const ds of [...chart.data.datasets.filter(d=>d.type==='line')])await addOrUpdate(ds.metaSymbol,ds.borderColor,ds.yAxisID,ds.yAxisID==='y0');}
setInterval(refreshAll,10000);

// ======== Clear Axis =========
document.getElementById("clearAxisBtn").addEventListener("click",()=>{
  axisHidden=!axisHidden;
  chart.options.scales.x.ticks.display=!axisHidden;chart.options.scales.x.grid.display=!axisHidden;
  Object.keys(chart.options.scales).forEach(k=>{if(k.startsWith('y')){chart.options.scales[k].ticks.display=!axisHidden;chart.options.scales[k].grid.display=!axisHidden;}});
  const btn=document.getElementById("clearAxisBtn");
  if(axisHidden){btn.style.backgroundColor="#00ff88";btn.style.color="#0f111a";}else{btn.style.backgroundColor="#1a1c2c";btn.style.color="#00ff88";}
  chart.update('none');
});
</script>
</body>
</html>
