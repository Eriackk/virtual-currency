<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Virtual Currency Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body{background:#0f111a;color:#fff;font-family:Arial, sans-serif;margin:0}
  h1{color:#00ff88;margin:20px 0 10px;text-align:left;padding-left:5vw}
  .controls{margin:6px 5vw;text-align:left}
  input,button{background:#1a1c2c;color:#00ff88;border:1px solid #00ff88;border-radius:4px;padding:6px 10px;font-size:1em;margin:4px}
  button:hover{background:#00ff88;color:#0f111a;cursor:pointer}
  .chart-container{position:relative;width:90vw;height:70vh;margin:20px auto}
  .time{color:#aaa;font-size:.9em;margin-left:5vw}
  /* mind-map animation */
  .map-container{position:relative;display:inline-block}
  .branch-line{position:absolute;height:2px;background:#fff;top:50%;left:100%;width:0;transition:width .45s ease}
  .branch-up,.branch-down{position:absolute;width:2px;height:0;background:#fff;transition:height .35s ease .45s}
  .branch-up{top:50%;left:calc(100% + 90px)}
  .branch-down{top:50%;left:calc(100% + 90px)}
  .input-up,.input-down{position:absolute;left:calc(100% + 100px);width:180px;opacity:0;transition:opacity .25s ease .8s}
  .input-up{top:calc(50% - 40px)}
  .input-down{top:calc(50% + 18px)}
  .active .branch-line{width:90px}
  .active .branch-up,.active .branch-down{height:30px}
  .active .branch-up{top:calc(50% - 30px)}
  .active .branch-down{top:50%}
  .active .input-up,.active .input-down{opacity:1}
</style>
</head>
<body>
  <h1>Virtual Currency Price Trend</h1>

  <div class="controls">
    <!-- 主线 -->
    <input id="coinInput" type="text" placeholder="Enter main coin (e.g. ACA)"/>
    <button onclick="updatePrimary()">Update Chart</button>

    <!-- 时间切换 -->
    <button onclick="setBar('1m')">1m</button>
    <button onclick="setBar('1H')">1h</button>
    <button onclick="setBar('1D')">1d</button>
    <button onclick="setBar('1W')">1w</button>

    <!-- 平滑模式 -->
    <button id="smoothBtn" onclick="toggleSmooth()">Point Smooth</button>

    <!-- 添加/删除 -->
    <div class="map-container" id="mapContainer">
      <button id="addBtn">Add Coin</button>
      <div class="branch-line"></div>
      <div class="branch-up"></div>
      <div class="branch-down"></div>
      <input class="input-up" type="text" id="newCoin" placeholder="Coins (e.g. BTC, RAY, ETH)">
      <input class="input-down" type="text" id="note" placeholder="(optional)">
    </div>
  </div>

  <div class="time" id="updateTime">Loading...</div>
  <div class="chart-container"><canvas id="coinChart"></canvas></div>

<script>
const ctx=document.getElementById('coinChart').getContext('2d');

let chart;
let currentBar='1D';
let primarySymbol='ACA';
let tracked=[];
let lastBatch=[];
let smoothMode=false;
let addMode=true;

const GREEN='#00ff88';
const palette=['#ff4c4c','#4c8cff','#ffb84c','#a64dff','#4dd2ff','#ffd24d','#ff6ad5','#7cffd3'];

// 精度自适应
function decimalsFor(p){if(p>=1000)return 2;if(p>=10)return 2;if(p>=1)return 3;if(p>=0.1)return 4;return 5;}
function fmt(p){const d=decimalsFor(p);return p.toFixed(d);}

// 初始化Chart
function initChart(){
  chart=new Chart(ctx,{
    type:'line',
    data:{labels:[],datasets:[]},
    options:{
      responsive:true,maintainAspectRatio:false,
      interaction:{mode:'nearest',intersect:true},
      elements:{line:{tension:0},point:{radius:3}},
      plugins:{
        legend:{labels:{color:'#fff'}},
        tooltip:{
          enabled:true,
          callbacks:{label:(ctx)=>`${ctx.dataset.label}: ${fmt(ctx.parsed.y)}`}
        }
      },
      scales:{}
    }
  });
}
initChart();

// 添加Y轴（固定左侧）
function ensureAxis(axisId,color,grid){
  chart.options.scales[axisId]={
    type:'linear',
    position:'left',
    grid:{color:'rgba(255,255,255,0.08)',drawOnChartArea:grid},
    ticks:{color:color,callback:(v)=>fmt(Number(v))}
  };
}

// 获取数据
async function fetchCandles(symbol,bar,limit=60){
  const url=`https://www.okx.com/api/v5/market/candles?instId=${symbol}-USDT&bar=${bar}&limit=${limit}`;
  const res=await fetch(url);const json=await res.json();
  const raw=(json&&json.data)?json.data.reverse():[];
  return {
    labels:raw.map(d=>new Date(+d[0]).toLocaleString()),
    prices:raw.map(d=>parseFloat(d[4]))
  };
}

// 添加/更新线
async function addOrUpdate(symbol,color,axisId,grid){
  symbol=symbol.toUpperCase();
  ensureAxis(axisId,color,grid);
  const {labels,prices}=await fetchCandles(symbol,currentBar,60);
  if(chart.data.labels.length===0)chart.data.labels=labels;
  let ds=chart.data.datasets.find(d=>d.metaSymbol===symbol);
  if(!ds){
    ds={
      label:`${symbol}/USDT (${currentBar})`,
      data:prices,borderColor:color,
      backgroundColor:'transparent',borderWidth:2,
      tension:chart.options.elements.line.tension,
      pointRadius:chart.options.elements.point.radius,
      yAxisID:axisId,metaSymbol:symbol
    };
    chart.data.datasets.push(ds);
    tracked.push(symbol);
  }else{
    ds.data=prices;ds.label=`${symbol}/USDT (${currentBar})`;
  }
  chart.update();
  document.getElementById('updateTime').innerText='Last updated: '+new Date().toLocaleTimeString();
}

// 主线更新（删除旧主线再绘制）
async function updatePrimary(){
  const newSymbol=(document.getElementById('coinInput').value.trim()||'ACA').toUpperCase();
  chart.data.datasets=chart.data.datasets.filter(d=>d.metaSymbol!==primarySymbol);
  tracked=tracked.filter(s=>s!==primarySymbol);
  primarySymbol=newSymbol;
  await addOrUpdate(primarySymbol,GREEN,'y0',true);
}

// 时间切换
async function setBar(bar){
  currentBar=bar;
  chart.data.labels=[];
  for(const ds of chart.data.datasets)
    await addOrUpdate(ds.metaSymbol,ds.borderColor,ds.yAxisID,ds.yAxisID==='y0');
}

// 平滑模式
function toggleSmooth(){
  smoothMode=!smoothMode;
  chart.options.elements.line.tension=smoothMode?0.5:0;
  chart.options.elements.point.radius=smoothMode?0:3;
  chart.options.plugins.tooltip.enabled=!smoothMode;
  chart.data.datasets.forEach(ds=>{
    ds.tension=chart.options.elements.line.tension;
    ds.pointRadius=chart.options.elements.point.radius;
  });
  chart.update();
}

// Add/Delete 合并按钮逻辑
const addBtn=document.getElementById('addBtn');
const mapContainer=document.getElementById('mapContainer');
addBtn.addEventListener('click',async()=>{
  if(addMode){
    mapContainer.classList.add('active');
    document.getElementById('newCoin').focus();
    addBtn.textContent='Delete Coin';
    const handler=async(e)=>{
      if(e.type==='keyup'&&e.key!=='Enter')return;
      const raw=document.getElementById('newCoin').value.trim();
      if(!raw)return;
      const syms=raw.split(',').map(s=>s.trim().toUpperCase()).filter(Boolean);
      lastBatch=[];
      let colorIdx=0;
      let axisCounter=Object.keys(chart.options.scales).length;
      for(const sym of syms){
        const color=palette[colorIdx%palette.length];
        const axisId='y'+axisCounter++;
        await addOrUpdate(sym,color,axisId,false);
        lastBatch.push(sym);
        colorIdx++;
      }
      document.getElementById('newCoin').value='';
    };
    document.getElementById('newCoin').addEventListener('keyup',handler,{once:true});
  }else{
    if(lastBatch.length){
      chart.data.datasets=chart.data.datasets.filter(d=>!lastBatch.includes(d.metaSymbol));
      tracked=tracked.filter(s=>!lastBatch.includes(s));
      chart.update();
      lastBatch=[];
    }
    addBtn.textContent='Add Coin';
    mapContainer.classList.remove('active');
  }
  addMode=!addMode;
});

// 自动刷新
async function refreshAll(){
  for(const ds of chart.data.datasets)
    await addOrUpdate(ds.metaSymbol,ds.borderColor,ds.yAxisID,ds.yAxisID==='y0');
}
setInterval(refreshAll,10000);

// 启动
updatePrimary();
</script>
</body>
</html>
